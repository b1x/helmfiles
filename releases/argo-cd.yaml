repositories:
  - name: argo
    url: https://argoproj.github.io/argo-helm

releases:
  - name: argocd
    namespace: argo-cd
    chart: argo/argo-cd
    version: "1.7.3"
    installed: true
    # wait: true
    # hooks:
    #   - events: ["postsync"]
    #     showlogs: true
    #     command: "/bin/sh"
    #     args:
    #       [
    #         "-c",
    #         "kubectl apply -n argo -f https://raw.githubusercontent.com/argoproj/argo-rollouts/stable/manifests/install.yaml",
    #       ]
    values:
      - nameOverride: argocd

        server:
          extraArgs:
            insecure: true

          metrics:
            enabled: true
            service:
              annotations:
                prometheus.io/scrape: "true"
                prometheus.io/port: "8083"

          ingress:
            enabled: true
            annotations:
              kubernetes.io/ingress.class: nginx
              nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
              cert-manager.io/cluster-issuer: "letsencrypt-prod"
            hosts:
              - '{{ env "ARGO_CD_INGRESS_HOST" }}'
            tls:
              - secretName: argocd-server-tls
                hosts:
                  - '{{ env "ARGO_CD_INGRESS_HOST" }}'

          config:
            repositories: |
              - name: env-demo
                type: git
                url: https://github.com/opspresso/argocd-env-demo
              - name: stable
                type: helm
                url: https://kubernetes-charts.storage.googleapis.com
              - name: argo
                type: helm
                url: https://argoproj.github.io/argo-helm

        configs:
          secret:
            createSecret: true
            # argocdServerAdminPassword: "$(htpasswd -nbBC 10 '' 'password' | tr -d ':\n' | sed 's/$2y/$2a/')"
            argocdServerAdminPassword: '{{ requiredEnv "ARGO_CD_PASSWORD" }}'
